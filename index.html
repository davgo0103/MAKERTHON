<!DOCTYPE html>
<meta charset="utf-8">
<html>

<head>
    <title>Water Resource Contract Web Page</title>
</head>

<body>
    <h1>Water Resource Contract Web Page</h1>
    <label for="address">User Address:</label>
    <input type="text" id="user-address" />
    <br />
    <label for="usage">Usage Data:</label>
    <input type="number" id="usage-input" />
    <br />
    <label for="quality">Quality Data:</label>
    <input type="number" id="quality-input" />
    <br />
    <label for="reserve">Reserve Data:</label>
    <input type="number" id="reserve-input" />
    <br />
    <label for="recycled">Recycled Data:</label>
    <input type="number" id="recycled-input" />
    <br />
    <label for="billing">Billing Data:</label>
    <input type="number" id="billing-input" />
    <br />
    <label for="totalUsage">Total Usage:</label>
    <input type="number" id="total-input" />
    <br />
    <button onclick="setWaterData()" id = "set-water-data">Update Water Data</button>
    <br />
    <br />
    <button onclick="getWaterUsage()" id = "get-water-usage">Get Total Usage</button>
    <br /><br />
    <label for="userData">User Data:</label>
    <span id="userData"></span>
    <br />
    <button onclick="getWaterData()" id = "get-water-data">Get User Data</button>
        <br /><br />
    <label for="totalUsage">Total Usage:</label>
    <span id="uptotal"></span>
    <br />
    <br />
    <label for="totalUsage">Update Total Usage:</label>
    <input type="number" id="update-total-input" />
    <br />
    <button onclick="updateWaterUsage()" id = "update-water-usage">Update Water Usage</button>

</body>
<script src="https://cdn.jsdelivr.net/npm/web3@1.9.0/dist/web3.min.js"></script>
<script>
    const ABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "usage",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "quality",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "reserve",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "recycled",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "billing",
				"type": "uint256"
			}
		],
		"name": "setWaterData",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "usage",
				"type": "uint256"
			}
		],
		"name": "updateWaterUsage",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "usage",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "quality",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "reserve",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "recycled",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "billing",
				"type": "uint256"
			}
		],
		"name": "WaterDataUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "usage",
				"type": "uint256"
			}
		],
		"name": "WaterUsageUpdated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getWaterData",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "usage",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "quality",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "reserve",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "recycled",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "billing",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getWaterUsage",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "waterResources",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "usageData",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "qualityData",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "reserveData",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "recycledData",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "billingData",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "waterUsages",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    const CONTRACT_ADDRESS = "0xa400FCbE33C82FDD8d2a0b9235724ab72A6B12C7";
    
    //const web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:7545'));
    const web3 = new Web3(window.ethereum);
    const contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);

    async function setWaterData() {
        const address = document.getElementById("user-address").value;
        const usage = document.getElementById("usage-input").value;
        const quality = document.getElementById("quality-input").value;
        const reserve = document.getElementById("reserve-input").value;
        const recycled = document.getElementById("recycled-input").value;
        const billing = document.getElementById("billing-input").value;

        try {
            await contract.methods
                .setWaterData(address, usage, quality, reserve, recycled, billing)
                .send({ from: window.ethereum.selectedAddress });
            alert("Water data updated!");
        } catch (e) {
            console.error(e);
            alert("Error updating water data.");
        }
    }


    async function getWaterData() {
        const userAddress = document.getElementById("user-address").value;

        try {
            const waterContract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
            const waterData = await waterContract.methods.getWaterData(userAddress).call();
            document.getElementById("usage-input").value = waterData[0];
            document.getElementById("quality-input").value = waterData[1];
            document.getElementById("reserve-inpput").value = waterData[2];
            document.getElementById("recycled-inpput").value = waterData[3];
            document.getElementById("billing-input").value = waterData[4];
        } catch (error) {
            console.error(error);
        }
    }
    async function updateWaterUsage() {
        const userAddress = document.getElementById("user-address").value;
        const usage = document.getElementById("usage-input").value;

        try {
            const waterContract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
            await waterContract.methods.updateWaterUsage(userAddress, usage).send({ from: userAddress });
            alert("用水總量已更新");
        } catch (error) {
            console.error(error);
            alert("更新用水總量時發生錯誤");
        }
    }


    
    async function setWaterData() {
        const address = document.getElementById("user-address").value;
        const usage = document.getElementById("usage-input").value;
        const quality = document.getElementById("quality-input").value;
        const reserve = document.getElementById("reserve-input").value;
        const recycled = document.getElementById("recycled-input").value;
        const billing = document.getElementById("billing-input").value;

        // 檢查輸入是否為數字
        if (
            isNaN(parseInt(usage)) ||
            isNaN(parseInt(quality)) ||
            isNaN(parseInt(reserve)) ||
            isNaN(parseInt(recycled)) ||
            isNaN(parseInt(billing))
        ) {
            alert("請輸入數字！");
            return;
        }

        // 呼叫合約的 setWaterData 函數
        try {
            const contract = await new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
            const accounts = await web3.eth.getAccounts();
            await contract.methods
                .setWaterData(address, usage, quality, reserve, recycled, billing)
                .send({ from: accounts[0] ,gas: 1000000});
            alert("用水數據設置成功！");
        } catch (error) {
            console.error(error);
            alert("用水數據設置失敗！");
        }
    }



    async function updateWaterUsage() {
        const address = document.getElementById("user-address").value;
        const usage = document.getElementById("update-total-input").value;
        
        // 檢查輸入是否為數字
        if (isNaN(parseInt(usage))) {
            alert("請輸入數字！");
            return;
        }

        // 呼叫合約的 updateWaterUsage 函數
        try {
            const contract = await new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
            const accounts = await web3.eth.getAccounts();
            await contract.methods.updateWaterUsage(address, usage).send({ from: accounts[0] });
            alert("用水總量更新成功！");
        } catch (error) {
            console.error(error);
            alert("用水總量更新失敗！");
        }
    }



    async function getWaterData() {
        const address = document.getElementById("user-address").value;

        // 呼叫合約的 getWaterData 函數
        try {
            const contract = await new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
            const result = await contract.methods.getWaterData(address).call();
            const usage = result[0];
            const quality = result[1];
            const reserve = result[2];
            const recycled = result[3];
            const billing = result[4];

            // 顯示結果
            document.getElementById("total-input").value = "";
            document.getElementById("usage-input").value = usage;
            document.getElementById("quality-input").value = quality;
            document.getElementById("reserve-input").value = reserve;
            document.getElementById("recycled-input").value = recycled;
            document.getElementById("billing-input").value = billing;
        } catch (error) {
            console.error(error);
            alert("獲取用水數據失敗！");
        }
    }

    

    async function getWaterUsage() {
        const address = document.getElementById("user-address").value;
        
        const contractAbi = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "usage",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "quality",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "reserve",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "recycled",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "billing",
				"type": "uint256"
			}
		],
		"name": "setWaterData",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "usage",
				"type": "uint256"
			}
		],
		"name": "updateWaterUsage",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "usage",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "quality",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "reserve",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "recycled",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "billing",
				"type": "uint256"
			}
		],
		"name": "WaterDataUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "usage",
				"type": "uint256"
			}
		],
		"name": "WaterUsageUpdated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getWaterData",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "usage",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "quality",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "reserve",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "recycled",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "billing",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getWaterUsage",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "waterResources",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "usageData",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "qualityData",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "reserveData",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "recycledData",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "billingData",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "waterUsages",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]; // 填入 ABI

        const contract = new web3.eth.Contract(contractAbi, CONTRACT_ADDRESS);
        const usage = await contract.methods.getWaterUsage(address).call();

        document.getElementById("usage-input").value = "";
            document.getElementById("quality-input").value = "";
            document.getElementById("reserve-input").value = "";
            document.getElementById("recycled-input").value = "";
            document.getElementById("billing-input").value = "";
        document.getElementById("total-input").value = usage;
    }
</script>